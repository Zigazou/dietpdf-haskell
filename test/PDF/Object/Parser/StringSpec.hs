module PDF.Object.Parser.StringSpec
  ( spec
  ) where

import Data.Binary.Parser (parseDetail)
import Data.ByteString (ByteString)

import PDF.Object.Object (PDFObject (PDFString))
import PDF.Object.Parser.String (stringP)

import Test.Hspec (Spec, describe, it)

import Util.ParserHelper (itWith, shouldFail)


stringExamples :: [(ByteString, PDFObject)]
stringExamples =
  [ ("()"                , PDFString "")
  , ("(abc)"             , PDFString "abc")
  , ("(\\061\\62\\063)"  , PDFString "123")
  , ("(a\\((b)\\)c)"     , PDFString "a((b))c")
  , ("(a\\(b\\)c)"       , PDFString "a(b)c")
  , ("(\\\n\\\r\n)"      , PDFString "")
  , ("(\\n\\r\\n)"       , PDFString "\n\r\n")
  , ("(()()())"          , PDFString "()()()")
  , ("((\\\n)\\\n()())"  , PDFString "()()()")
  , ("((\\\r\n)\\\n()())", PDFString "()()()")
  , ( "(\xf6\x2e\x95\x40\x01\x93\x12\xf9\xc8\xae\x5c\x29\xca\xeb\x05\x48\
      \\x81\xc1\x39\x68\xe4\x48\x2c\xc4\x9d\x91\x71\xac\xe9\xb0\x59\x5c\
      \\x72\x52)"
    , PDFString
      "\xf6\x2e\x95\x40\x01\x93\x12\xf9\xc8\xae\x29\xca\xeb\x05\x48\
      \\x81\xc1\x39\x68\xe4\x48\x2c\xc4\x9d\x91\x71\xac\xe9\xb0\x59\
      \\x0d\x52"
    )
  , ( "(\xfe\xff\x00\x46\x00\x72\x00\xe9\x00\x64\x00\xe9\x00\x72\x00\x69\x00\x63)"
    , PDFString "\xfe\xff\x00\x46\x00\x72\x00\xe9\x00\x64\x00\xe9\x00\x72\x00\x69\x00\x63"
    )
  , ( "(\xfe\xff\x00\x46\x00\x72\x00\xe9\x00\x64\x00\xe9\x00\x72\x00\x69\x00\x63\x00\\))"
    , PDFString "\xfe\xff\x00\x46\x00\x72\x00\xe9\x00\x64\x00\xe9\x00\x72\x00\x69\x00\x63\x00)"
    )
  , ("(\xfe\xff\x00O\x00\\)\x00K)", PDFString "\xfe\xff\x00O\x00)\x00K")
  , ("(\xfe\xff\x00O\x00\\\\\x00K)", PDFString "\xfe\xff\x00O\x00\\\x00K")
  , ("(\xfe\xff\x00\x4c\x00\x61\x00\x20\x00\x42\x00\x61\x00\x6e\x00\x20\x00\x5c\
      \\x28\x00\x64\x00\x6f\x00\x6e\x00\x6e\x00\xe9\x00\x65\x00\x73\x00\x20\x00\
      \\x64\x00\x65\x00\x20\x00\x72\x00\xe9\x00\x66\x00\xe9\x00\x72\x00\x65\x00\
      \\x6e\x00\x63\x00\x65\x00\x5c\x29)"
    , PDFString "\xfe\xff\x00\x4c\x00\x61\x00\x20\x00\x42\x00\x61\x00\x6e\x00\
      \\x20\x00\x28\x00\x64\x00\x6f\x00\x6e\x00\x6e\x00\xe9\x00\x65\x00\x73\x00\
      \\x20\x00\x64\x00\x65\x00\x20\x00\x72\x00\xe9\x00\x66\x00\xe9\x00\x72\x00\
      \\x65\x00\x6e\x00\x63\x00\x65\x00\x29"
    )
  ]

spec :: Spec
spec = describe "stringP" $ do
  it "should fail with unknown escaped character (ab\\c)" $ do
    let parsed = parseDetail stringP "(ab\\c)"
    shouldFail parsed

  mapM_ (itWith "should work with " stringP) stringExamples
